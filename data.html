<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>更新日志</title>
  <!-- Tailwind CSS v3 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#64748b',
            accent: '#f97316',
            dark: '#1e293b',
            light: '#f8fafc'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-down': 'slideDown 0.3s ease-out',
            'pulse-gentle': 'pulseGentle 2s infinite',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideDown: {
              '0%': { transform: 'translateY(-10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            pulseGentle: {
              '0%, 100%': { opacity: '1' },
              '50%': { opacity: '0.7' },
            },
          },
          boxShadow: {
            'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
            'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .glass-effect {
        @apply bg-white bg-opacity-80 backdrop-blur-md;
      }
      
      .card-transition {
        @apply transition-all duration-300 ease-in-out;
      }
      
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      
      .change-item {
        @apply flex items-start mb-2 last:mb-0;
      }
      
      .change-icon {
        @apply mr-2 mt-1 text-sm;
      }
      
      .feature-icon {
        @apply text-primary;
      }
      
      .improvement-icon {
        @apply text-secondary;
      }
      
      .fix-icon {
        @apply text-accent;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">
  <!-- 顶部导航栏 -->
  <header class="sticky top-0 z-50 glass-effect border-b border-gray-200 shadow-sm">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-history text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-primary">更新日志</h1>
      </div>
      <div class="flex items-center space-x-4">
        <div id="last-updated" class="text-sm text-gray-500 hidden md:block">
          最后更新: <span class="font-medium">加载中...</span>
        </div>
        <button id="refresh-btn" class="flex items-center space-x-1 px-3 py-1.5 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
          <i class="fa fa-refresh"></i>
          <span class="hidden sm:inline">刷新</span>
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="container mx-auto px-4 py-8">
    <!-- 状态提示 -->
    <div id="status-message" class="mb-6 hidden">
      <div class="bg-blue-50 border-l-4 border-primary p-4 rounded-md shadow-sm">
        <div class="flex">
          <div class="flex-shrink-0">
            <i class="fa fa-info-circle text-primary"></i>
          </div>
          <div class="ml-3">
            <p class="text-sm text-gray-700" id="status-text"></p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 筛选和搜索 -->
    <div class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
      <div class="flex flex-wrap gap-2">
        <button class="filter-btn active px-3 py-1 rounded-full text-sm font-medium bg-primary text-white" data-filter="all">
          全部更新
        </button>
        <button class="filter-btn px-3 py-1 rounded-full text-sm font-medium bg-gray-200 hover:bg-gray-300" data-filter="important">
          重要更新
        </button>
        <button class="filter-btn px-3 py-1 rounded-full text-sm font-medium bg-gray-200 hover:bg-gray-300" data-filter="features">
          新功能
        </button>
      </div>
      <div class="w-full sm:w-auto relative">
        <input type="text" id="search-input" placeholder="搜索更新内容..." 
               class="w-full sm:w-64 px-4 py-2 pl-10 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
        <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
      </div>
    </div>
    
    <!-- 更新日志列表 -->
    <div id="changelog-container" class="space-y-6">
      <!-- 加载状态 -->
      <div id="loading" class="py-12 flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-600">加载更新日志中...</p>
      </div>
      
      <!-- 空状态 -->
      <div id="empty-state" class="hidden py-12 flex flex-col items-center justify-center">
        <i class="fa fa-inbox text-5xl text-gray-300"></i>
        <p class="mt-4 text-gray-600">没有找到符合条件的更新记录</p>
      </div>
      
      <!-- 更新日志卡片将通过JavaScript动态生成 -->
    </div>
  </main>
  
  <!-- 页脚 -->
  <footer class="bg-gray-100 border-t border-gray-200 py-6 mt-12">
    <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
      <p>更新日志自动生成系统 &copy; 2026</p>
      <p class="mt-1">数据来源: <code class="bg-gray-200 px-1 py-0.5 rounded">data.json</code></p>
    </div>
  </footer>

  <script>
    // 全局变量
    let changelogData = [];
    let lastModifiedTime = 0;
    let autoRefreshInterval;
    
    // DOM元素
    const changelogContainer = document.getElementById('changelog-container');
    const loadingElement = document.getElementById('loading');
    const emptyStateElement = document.getElementById('empty-state');
    const statusMessageElement = document.getElementById('status-message');
    const statusTextElement = document.getElementById('status-text');
    const lastUpdatedElement = document.getElementById('last-updated');
    const refreshBtn = document.getElementById('refresh-btn');
    const searchInput = document.getElementById('search-input');
    const filterButtons = document.querySelectorAll('.filter-btn');
    
    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      loadChangelog();
      setupEventListeners();
      startAutoRefresh();
    });
    
    // 加载更新日志数据
    async function loadChangelog(showNotification = true) {
      try {
        // 添加时间戳参数以避免缓存
        const timestamp = new Date().getTime();
        const response = await fetch(`data.json?t=${timestamp}`, {
          headers: {
            'Cache-Control': 'no-cache'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // 获取文件最后修改时间
        const lastModified = response.headers.get('Last-Modified');
        if (lastModified) {
          const modifiedTime = new Date(lastModified).getTime();
          // 如果文件没有变化，则不重新加载
          if (modifiedTime === lastModifiedTime && !showNotification) {
            return;
          }
          lastModifiedTime = modifiedTime;
          updateLastModifiedDisplay(lastModified);
        }
        
        const data = await response.json();
        changelogData = data.changelog || [];
        
        // 按日期倒序排序
        changelogData.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        renderChangelog();
        
        if (showNotification) {
          showStatus('更新日志已加载', 'success');
        }
        
      } catch (error) {
        console.error('加载更新日志失败:', error);
        showStatus('加载更新日志失败，请稍后重试', 'error');
        showEmptyState();
      } finally {
        loadingElement.classList.add('hidden');
      }
    }
    
    // 渲染更新日志
    function renderChangelog() {
      changelogContainer.innerHTML = '';
      
      if (changelogData.length === 0) {
        showEmptyState();
        return;
      }
      
      const searchTerm = searchInput.value.toLowerCase().trim();
      const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
      
      let filteredData = changelogData;
      
      // 应用筛选
      if (activeFilter !== 'all') {
        if (activeFilter === 'important') {
          filteredData = filteredData.filter(item => item.important);
        } else if (activeFilter === 'features') {
          filteredData = filteredData.filter(item => 
            item.changes && item.changes.features && item.changes.features.length > 0
          );
        }
      }
      
      // 应用搜索
      if (searchTerm) {
        filteredData = filteredData.filter(item => {
          // 搜索版本号、标题、描述
          if (item.version.toLowerCase().includes(searchTerm) || 
              item.title.toLowerCase().includes(searchTerm) || 
              (item.description && item.description.toLowerCase().includes(searchTerm))) {
            return true;
          }
          
          // 搜索变更内容
          if (item.changes) {
            for (const [type, changes] of Object.entries(item.changes)) {
              if (changes.some(change => change.toLowerCase().includes(searchTerm))) {
                return true;
              }
            }
          }
          
          return false;
        });
      }
      
      if (filteredData.length === 0) {
        showEmptyState();
        return;
      }
      
      // 创建并添加更新日志卡片
      filteredData.forEach((item, index) => {
        const card = createChangelogCard(item, index);
        changelogContainer.appendChild(card);
      });
    }
    
    // 创建更新日志卡片
    function createChangelogCard(item, index) {
      const card = document.createElement('div');
      card.className = `bg-white rounded-lg shadow-card card-transition hover:shadow-card-hover animate-fade-in animate-delay-${index % 5}`;
      card.style.animationDelay = `${index * 100}ms`;
      
      // 确定卡片边框颜色
      let borderClass = '';
      if (item.important) {
        borderClass = 'border-l-4 border-accent';
      }
      
      // 格式化日期
      const formattedDate = formatDate(item.date);
      
      // 构建卡片HTML
      card.innerHTML = `
        <div class="p-6 ${borderClass}">
          <div class="flex flex-col md:flex-row md:justify-between md:items-start mb-4">
            <div>
              <div class="flex items-center">
                <h3 class="text-xl font-bold text-gray-800">${item.title || '更新'}</h3>
                ${item.important ? '<span class="ml-2 px-2 py-0.5 bg-accent/10 text-accent text-xs font-medium rounded-full">重要更新</span>' : ''}
              </div>
              <div class="flex items-center mt-1 text-sm text-gray-500">
                <span class="font-mono">v${item.version}</span>
                <span class="mx-2">•</span>
                <span>${formattedDate}</span>
              </div>
            </div>
            <button class="expand-btn mt-2 md:mt-0 self-start px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md text-sm font-medium transition-colors">
              <i class="fa fa-chevron-down mr-1"></i> 查看详情
            </button>
          </div>
          
          ${item.description ? `<p class="text-gray-600 mb-4">${item.description}</p>` : ''}
          
          <div class="expanded-content hidden mt-4 pt-4 border-t border-gray-100 animate-slide-down">
            ${renderChanges(item.changes)}
          </div>
        </div>
      `;
      
      // 添加展开/折叠功能
      const expandBtn = card.querySelector('.expand-btn');
      const expandedContent = card.querySelector('.expanded-content');
      
      expandBtn.addEventListener('click', () => {
        const isExpanded = !expandedContent.classList.contains('hidden');
        
        if (isExpanded) {
          expandedContent.classList.add('hidden');
          expandBtn.innerHTML = '<i class="fa fa-chevron-down mr-1"></i> 查看详情';
        } else {
          expandedContent.classList.remove('hidden');
          expandBtn.innerHTML = '<i class="fa fa-chevron-up mr-1"></i> 收起详情';
        }
      });
      
      return card;
    }
    
    // 渲染变更内容
    function renderChanges(changes) {
      if (!changes || Object.keys(changes).length === 0) {
        return '<p class="text-gray-500">暂无详细变更信息</p>';
      }
      
      let html = '';
      
      // 定义变更类型的配置
      const changeTypes = {
        features: { title: '新功能', icon: 'fa-plus-circle', class: 'feature-icon' },
        improvements: { title: '改进', icon: 'fa-refresh', class: 'improvement-icon' },
        fixes: { title: '修复', icon: 'fa-bug', class: 'fix-icon' }
      };
      
      // 按顺序渲染各类变更
      for (const [type, items] of Object.entries(changeTypes)) {
        if (changes[type] && changes[type].length > 0) {
          html += `
            <div class="mb-4 last:mb-0">
              <h4 class="flex items-center text-sm font-semibold text-gray-700 mb-2">
                <i class="fa ${items.icon} ${items.class} mr-2"></i>
                ${items.title}
              </h4>
              <ul class="pl-6">
                ${changes[type].map(change => `
                  <li class="change-item">
                    <i class="fa ${items.icon} change-icon ${items.class}"></i>
                    <span>${change}</span>
                  </li>
                `).join('')}
              </ul>
            </div>
          `;
        }
      }
      
      return html;
    }
    
    // 格式化日期
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }
    
    // 更新最后修改时间显示
    function updateLastModifiedDisplay(lastModified) {
      if (lastUpdatedElement) {
        const date = new Date(lastModified);
        const formattedDate = date.toLocaleString('zh-CN', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        lastUpdatedElement.querySelector('span').textContent = formattedDate;
      }
    }
    
    // 显示状态消息
    function showStatus(message, type = 'info') {
      statusTextElement.textContent = message;
      statusMessageElement.classList.remove('hidden');
      
      // 设置消息类型样式
      const container = statusMessageElement.querySelector('div');
      container.className = 'flex';
      
      if (type === 'success') {
        container.classList.add('bg-green-50', 'border-green-500');
        container.querySelector('i').className = 'fa fa-check-circle text-green-500';
      } else if (type === 'error') {
        container.classList.add('bg-red-50', 'border-red-500');
        container.querySelector('i').className = 'fa fa-exclamation-circle text-red-500';
      } else {
        container.classList.add('bg-blue-50', 'border-primary');
        container.querySelector('i').className = 'fa fa-info-circle text-primary';
      }
      
      // 3秒后自动隐藏
      setTimeout(() => {
        statusMessageElement.classList.add('hidden');
      }, 5000);
    }
    
    // 显示空状态
    function showEmptyState() {
      emptyStateElement.classList.remove('hidden');
    }
    
    // 设置事件监听器
    function setupEventListeners() {
      // 刷新按钮点击事件
      refreshBtn.addEventListener('click', () => {
        refreshBtn.disabled = true;
        refreshBtn.classList.add('animate-pulse-gentle');
        
        loadChangelog().finally(() => {
          refreshBtn.disabled = false;
          refreshBtn.classList.remove('animate-pulse-gentle');
        });
      });
      
      // 搜索输入事件
      searchInput.addEventListener('input', debounce(() => {
        renderChangelog();
      }, 300));
      
      // 筛选按钮点击事件
      filterButtons.forEach(button => {
        button.addEventListener('click', () => {
          // 移除所有按钮的活动状态
          filterButtons.forEach(btn => {
            btn.classList.remove('active', 'bg-primary', 'text-white');
            btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
          });
          
          // 添加当前按钮的活动状态
          button.classList.add('active', 'bg-primary', 'text-white');
          button.classList.remove('bg-gray-200', 'hover:bg-gray-300');
          
          renderChangelog();
        });
      });
    }
    
    // 启动自动刷新
    function startAutoRefresh() {
      // 每60秒自动检查更新
      autoRefreshInterval = setInterval(() => {
        loadChangelog(false);
      }, 60000);
    }
    
    // 防抖函数
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          func.apply(context, args);
        }, wait);
      };
    }
  </script>
</body>
</html>